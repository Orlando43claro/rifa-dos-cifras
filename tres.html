<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa de tres cifras</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #e0eafc, #cfdef3);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        h1 {
            color: #2c3e50;
            font-size: clamp(1.8em, 5vw, 2.5em);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            margin: 0;
        }

        p {
            color: #34495e;
            font-size: clamp(0.9em, 3vw, 1em);
            margin: 10px 0;
        }

        .controles {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        #contadorVendidos {
            color: #2c3e50;
            font-size: 1em;
            font-weight: 600;
            background: #ffffff;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .filtros {
            display: flex;
            gap: 8px;
        }

        .filtro {
            position: relative;
            padding: 6px 12px;
            background: #95a5a6;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            transition: background 0.2s, box-shadow 0.2s;
        }

        .filtro.activo {
            background: #1e90ff;
            box-shadow: 0 0 8px rgba(30, 144, 255, 0.5);
        }

        #filtroTodo:hover:not(.activo) {
            background: #3498db;
        }

        #filtroDisponible {
            background: #0288d1;
        }

        #filtroDisponible.activo {
            background: #0277bd;
            box-shadow: 0 0 8px rgba(2, 136, 209, 0.5);
        }

        #filtroDisponible:hover:not(.activo) {
            background: #039be5;
        }

        #filtroApartado {
            background: #e74c3c;
        }

        #filtroApartado.activo {
            background: #c0392b;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.5);
        }

        #filtroApartado:hover:not(.activo) {
            background: #d32f2f;
        }

        #filtroPagado {
            background: #2ecc71;
        }

        #filtroPagado.activo {
            background: #27ae60;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.5);
        }

        #filtroPagado:hover:not(.activo) {
            background: #4caf50;
        }

        .notificacion-filtro {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: #fff;
            font-size: 0.6em;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 71, 87, 0.7);
        }

        #limpiarTalonario {
            padding: 12px 20px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s, transform 0.2s;
        }

        #limpiarTalonario:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: scale(1.05);
        }

        #talonario {
            max-width: 900px;
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
            margin-bottom: 20px;
            min-height: 300px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 6px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 8px;
            table-layout: fixed;
            display: table !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        tr {
            display: table-row !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        td {
            width: 10%;
            height: 50px;
            background: linear-gradient(135deg, #6dd5fa, #2980b9);
            color: #fff;
            font-size: clamp(0.9em, 2.5vw, 1.1em);
            font-weight: 600;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: table-cell !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        td:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        td.seleccionado {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: #fff;
        }

        td.pagado {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: #fff;
        }

        td.oculta {
            display: none;
        }

        .paginacion {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .paginacion button {
            padding: 8px 16px;
            background: #2980b9;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .paginacion button:hover {
            background: #3498db;
        }

        .paginacion button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        #listaBoletos {
            max-width: 900px;
            width: 100%;
            padding: 20px 10px;
            box-sizing: border-box;
            margin-top: 20px;
        }

        #listaBoletos h2 {
            color: #2c3e50;
            font-size: clamp(1.2em, 4vw, 1.5em);
            margin-bottom: 15px;
            text-align: center;
        }

        #lista {
            list-style: none;
            padding: 0;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }

        #lista li {
            padding: 10px;
            font-size: clamp(0.9em, 2.5vw, 1em);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #lista li:last-child {
            border-bottom: none;
        }

        #lista li.apartado {
            color: #e74c3c;
        }

        #lista li.pagado {
            color: #27ae60;
        }

        #lista li span {
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .cerrar {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #333;
        }

        .modal-content h2 {
            margin: 0 0 15px;
            color: #2c3e50;
            font-size: 1.4em;
        }

        .modal-content p {
            color: #34495e;
            font-size: 1em;
            margin: 10px 0 20px;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-content label {
            font-size: 1em;
            color: #34495e;
        }

        .modal-content input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .modal-content .botones {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-content button {
            padding: 10px;
            background: #2980b9;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
            flex: 1;
            min-width: 100px;
        }

        .modal-content button:hover {
            background: #3498db;
        }

        .modal-content #eliminarBoleto {
            background: #e74c3c;
        }

        .modal-content #eliminarBoleto:hover {
            background: #c0392b;
        }

        .modal-content #marcarPago {
            background: #27ae60;
        }

        .modal-content #marcarPago:hover {
            background: #2ecc71;
        }

        .modal-content #marcarPago:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        #modalConfirmarLimpieza .modal-content p {
            color: #34495e;
            font-size: 1em;
            margin: 10px 0 20px;
        }

        #modalConfirmarLimpieza .botones {
            justify-content: space-between;
        }

        #confirmarLimpieza {
            background: #e74c3c;
        }

        #confirmarLimpieza:hover {
            background: #c0392b;
        }

        #cancelarLimpieza {
            background: #7f8c8d;
        }

        #cancelarLimpieza:hover {
            background: #95a5a6;
        }

        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff7f;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 127, 0.7);
            z-index: 2000;
            display: none;
            animation: slideIn 0.5s ease forwards, slideOut 0.5s ease 2.5s forwards;
        }

        .notificacion p {
            margin: 0;
            font-size: 1em;
            font-weight: 600;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 600px) {
            table {
                border-spacing: 4px;
            }
            td {
                height: 40px;
                font-size: clamp(0.8em, 2.2vw, 0.9em);
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .modal-content .botones {
                flex-direction: column;
            }
            .controles {
                flex-direction: column;
                gap: 10px;
            }
            .filtros {
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px;
            }
            .filtro {
                padding: 5px 10px;
                font-size: 0.7em;
            }
            .notificacion-filtro {
                top: -6px;
                right: -6px;
                font-size: 0.5em;
                padding: 1px 4px;
            }
            .paginacion button {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            #contadorVendidos {
                font-size: 0.9em;
                padding: 4px 8px;
            }
            #limpiarTalonario {
                padding: 8px 16px;
                font-size: 0.9em;
            }
            .notificacion {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 0.9em;
            }
            #listaBoletos {
                padding: 15px 5px;
            }
            #lista li {
                font-size: clamp(0.8em, 2.2vw, 0.9em);
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }

        @media (max-width: 400px) {
            table {
                border-spacing: 3px;
            }
            td {
                height: 30px;
                font-size: clamp(0.7em, 2vw, 0.8em);
            }
        }

        @media print {
            body {
                background: none;
            }
            header, .modal, #modalConfirmarLimpieza, .notificacion, #listaBoletos, .paginacion {
                display: none;
            }
            #talonario {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
            table {
                box-shadow: none;
                border-spacing: 2px;
            }
            td {
                border: 1px solid #333;
                background: #fff;
                color: #000;
                font-size: 0.9em;
                border-radius: 0;
            }
            td.seleccionado {
                background: #ccc;
                color: #000;
            }
            td.pagado {
                background: #999;
                color: #000;
            }
        }
    </style>
    <link rel="icon" id="favicon" type="image/png" href="icono-talonariodigital.png">
</head>
<body>
    <header>
        <div class="logo">
            <h1>Rifa de tres cifras</h1>
        </div>
        <p>Haz clic en un número para apartarlo, editarlo o pagarlo</p>
        <div class="info">
            <p><strong>Responsable:</strong> <span id="responsable"></span></p>
            <p><strong>Premio:</strong> <span id="premio"></span></p>
        </div>
        <div class="controles">
            <span id="contadorVendidos">Apartados y Pagados: 0/1000</span>
            <div class="filtros">
                <button id="filtroTodo" class="filtro activo">Todo <span class="notificacion-filtro" id="contadorTodo">1000</span></button>
                <button id="filtroDisponible" class="filtro">Disponible <span class="notificacion-filtro" id="contadorDisponible">1000</span></button>
                <button id="filtroApartado" class="filtro">Apartado <span class="notificacion-filtro" id="contadorApartado">0</span></button>
                <button id="filtroPagado" class="filtro">Pagado <span class="notificacion-filtro" id="contadorPagado">0</span></button>
            </div>
        </div>
    </header>
    <div id="talonario">
        <p style="color: blue;">Cargando talonario...</p>
    </div>
    <div class="paginacion">
        <button id="anteriorPagina" disabled>Anterior</button>
        <span id="paginaActual">Página 1 de 10</span>
        <button id="siguientePagina">Siguiente</button>
    </div>
    <button id="limpiarTalonario" style="display: none;">Clic para Nueva Rifa</button>
    <div id="listaBoletos">
        <h2>Lista de Boletos</h2>
        <ul id="lista"></ul>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span id="cerrarModal" class="cerrar">×</span>
            <h2><span id="modalTitulo">Registrar</span> Boleto <span id="numeroBoleto"></span></h2>
            <form id="formRegistro">
                <label for="nombre">Nombre:</label>
                <input type="text" id="nombre" name="nombre" required>
                <label for="celular">Celular:</label>
                <input type="tel" id="celular" name="celular" required>
                <div class="botones">
                    <button type="submit">Guardar</button>
                    <button type="button" id="eliminarBoleto" style="display: none;">Eliminar</button>
                    <button type="button" id="marcarPago" style="display: none;">Marcar como Pagado</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modalConfirmarLimpieza" class="modal">
        <div class="modal-content">
            <span id="cerrarModalConfirmar" class="cerrar">×</span>
            <h2>Confirmar Nueva Rifa</h2>
            <p>¿Estás seguro de que deseas limpiar el talonario para iniciar una nueva rifa? Esto eliminará todos los datos actuales.</p>
            <div class="botones">
                <button id="confirmarLimpieza">Confirmar</button>
                <button id="cancelarLimpieza">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="notificacion" class="notificacion">
        <p id="mensajeNotificacion"></p>
    </div>
    <script>
        let filtroActivo = 'todo';
        let paginaActual = 1;
        const numerosPorPagina = 100;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado, inicializando TalonarioDigital...');
            filtroActivo = 'todo';
            document.getElementById('filtroTodo').classList.add('activo');
            document.getElementById('filtroDisponible').classList.remove('activo');
            document.getElementById('filtroApartado').classList.remove('activo');
            document.getElementById('filtroPagado').classList.remove('activo');

            // Mostrar responsable y premio
            const responsableSpan = document.getElementById('responsable');
            const premioSpan = document.getElementById('premio');
            responsableSpan.textContent = localStorage.getItem('rifaResponsable') || 'No especificado';
            premioSpan.textContent = localStorage.getItem('rifaPremio') || 'No especificado';

            setTimeout(() => {
                generarTalonario();
                inicializarLimpiarTalonario();
                inicializarPaginacion();
                generarFavicon();
            }, 500);

            document.getElementById('filtroTodo').addEventListener('click', () => aplicarFiltro('todo'));
            document.getElementById('filtroDisponible').addEventListener('click', () => aplicarFiltro('disponible'));
            document.getElementById('filtroApartado').addEventListener('click', () => aplicarFiltro('apartado'));
            document.getElementById('filtroPagado').addEventListener('click', () => aplicarFiltro('pagado'));
        });

        function generarTalonario() {
            console.log('Iniciando generarTalonario');
            const talonario = document.getElementById('talonario');
            if (!talonario) {
                console.error('El contenedor #talonario no se encontró');
                document.body.innerHTML += '<p style="color: red;">Error: Contenedor #talonario no encontrado</p>';
                return;
            }
            talonario.innerHTML = ''; // Limpiar contenido previo

            let seleccionados = [];
            let pagados = [];
            let datosBoletos = {};
            let talonarioCompleto = false;
            try {
                seleccionados = JSON.parse(localStorage.getItem('numerosSeleccionados3')) || [];
                pagados = JSON.parse(localStorage.getItem('numerosPagados3')) || [];
                datosBoletos = JSON.parse(localStorage.getItem('datosBoletos3')) || {};
                talonarioCompleto = localStorage.getItem('talonarioCompleto3') === 'true';
                if (!Array.isArray(seleccionados) || !Array.isArray(pagados)) {
                    console.warn('Datos de localStorage inválidos, reiniciando...');
                    seleccionados = [];
                    pagados = [];
                    localStorage.setItem('numerosSeleccionados3', JSON.stringify(seleccionados));
                    localStorage.setItem('numerosPagados3', JSON.stringify(pagados));
                }
            } catch (error) {
                console.error('Error al leer localStorage:', error);
                talonario.innerHTML = '<p style="color: red;">Error al cargar datos: ' + error.message + '</p>';
                seleccionados = [];
                pagados = [];
                datosBoletos = {};
                talonarioCompleto = false;
                localStorage.setItem('numerosSeleccionados3', JSON.stringify(seleccionados));
                localStorage.setItem('numerosPagados3', JSON.stringify(pagados));
                localStorage.setItem('datosBoletos3', JSON.stringify(datosBoletos));
                localStorage.setItem('talonarioCompleto3', 'false');
            }

            try {
                const tabla = document.createElement('table');
                const inicio = (paginaActual - 1) * numerosPorPagina;
                const fin = Math.min(inicio + numerosPorPagina, 1000);
                let numero = inicio;

                for (let i = 0; i < 10; i++) {
                    const fila = document.createElement('tr');
                    for (let j = 0; j < 10; j++) {
                        if (numero >= fin) break;
                        const celda = document.createElement('td');
                        celda.textContent = numero.toString().padStart(3, '0');
                        celda.dataset.numero = numero;

                        if (pagados.includes(numero.toString())) {
                            celda.classList.add('pagado');
                        } else if (seleccionados.includes(numero.toString())) {
                            celda.classList.add('seleccionado');
                        }

                        if (filtroActivo === 'disponible' && (celda.classList.contains('seleccionado') || celda.classList.contains('pagado'))) {
                            celda.classList.add('oculta');
                        } else if (filtroActivo === 'apartado' && !celda.classList.contains('seleccionado')) {
                            celda.classList.add('oculta');
                        } else if (filtroActivo === 'pagado' && !celda.classList.contains('pagado')) {
                            celda.classList.add('oculta');
                        }

                        celda.addEventListener('click', function () {
                            const isPagado = this.classList.contains('pagado');
                            const isSeleccionado = this.classList.contains('seleccionado');
                            mostrarModal(this, isPagado ? 'ver' : (isSeleccionado ? 'editar' : 'registrar'));
                        });

                        fila.appendChild(celda);
                        numero++;
                    }
                    if (fila.children.length > 0) {
                        tabla.appendChild(fila);
                    }
                }

                talonario.appendChild(tabla);
                tabla.style.display = 'table';
                tabla.offsetHeight; // Forzar reflow

                actualizarControles(seleccionados, pagados);
                generarListaBoletos();
                if (talonarioCompleto) {
                    document.getElementById('limpiarTalonario').style.display = 'block';
                } else {
                    verificarTalonarioCompleto(pagados);
                }
                actualizarPaginacion();
            } catch (error) {
                console.error('Error al crear la tabla:', error);
                talonario.innerHTML = '<p style="color: red;">Error al crear la tabla: ' + error.message + '</p>';
            }
        }

        function inicializarPaginacion() {
            const anteriorBtn = document.getElementById('anteriorPagina');
            const siguienteBtn = document.getElementById('siguientePagina');
            anteriorBtn.addEventListener('click', () => {
                if (paginaActual > 1) {
                    paginaActual--;
                    generarTalonario();
                }
            });
            siguienteBtn.addEventListener('click', () => {
                if (paginaActual < 10) {
                    paginaActual++;
                    generarTalonario();
                }
            });
        }

        function actualizarPaginacion() {
            const anteriorBtn = document.getElementById('anteriorPagina');
            const siguienteBtn = document.getElementById('siguientePagina');
            const paginaActualSpan = document.getElementById('paginaActual');
            anteriorBtn.disabled = paginaActual === 1;
            siguienteBtn.disabled = paginaActual === 10;
            paginaActualSpan.textContent = `Página ${paginaActual} de 10`;
        }

        function mostrarModal(celda, modo) {
            const modal = document.getElementById('modal');
            const modalTitulo = document.getElementById('modalTitulo');
            const numeroBoleto = document.getElementById('numeroBoleto');
            const form = document.getElementById('formRegistro');
            const nombreInput = document.getElementById('nombre');
            const celularInput = document.getElementById('celular');
            const eliminarBoleto = document.getElementById('eliminarBoleto');
            const marcarPago = document.getElementById('marcarPago');
            const numero = celda.dataset.numero;

            modalTitulo.textContent = modo === 'editar' ? 'Editar' : (modo === 'ver' ? 'Ver' : 'Registrar');
            numeroBoleto.textContent = numero.padStart(3, '0');
            modal.style.display = 'flex';

            const datosBoletos = JSON.parse(localStorage.getItem('datosBoletos3')) || {};
            if (datosBoletos[numero]) {
                nombreInput.value = datosBoletos[numero].nombre || '';
                celularInput.value = datosBoletos[numero].celular || '';
            } else {
                nombreInput.value = '';
                celularInput.value = '';
            }

            eliminarBoleto.style.display = (modo === 'editar' || modo === 'ver') ? 'block' : 'none';
            marcarPago.style.display = modo === 'editar' ? 'block' : 'none';
            marcarPago.disabled = modo === 'ver';
            nombreInput.disabled = modo === 'ver';
            celularInput.disabled = modo === 'ver';
            form.querySelector('button[type="submit"]').style.display = modo === 'ver' ? 'none' : 'block';

            form.onsubmit = function (e) {
                e.preventDefault();
                let seleccionados = JSON.parse(localStorage.getItem('numerosSeleccionados3')) || [];
                let pagados = JSON.parse(localStorage.getItem('numerosPagados3')) || [];
                if (!celda.classList.contains('seleccionado') && !celda.classList.contains('pagado')) {
                    celda.classList.add('seleccionado');
                    if (!seleccionados.includes(numero.toString())) {
                        seleccionados.push(numero.toString());
                    }
                }
                datosBoletos[numero] = {
                    nombre: nombreInput.value,
                    celular: celularInput.value
                };
                actualizarLocalStorage(seleccionados, pagados, datosBoletos);
                modal.style.display = 'none';
                generarTalonario();
                mostrarNotificacion(`Boleto ${numero.padStart(3, '0')} registrado/apartado exitosamente`);
            };

            eliminarBoleto.onclick = function () {
                let seleccionados = JSON.parse(localStorage.getItem('numerosSeleccionados3')) || [];
                let pagados = JSON.parse(localStorage.getItem('numerosPagados3')) || [];
                celda.classList.remove('seleccionado', 'pagado');
                seleccionados = seleccionados.filter(n => n !== numero.toString());
                pagados = pagados.filter(n => n !== numero.toString());
                delete datosBoletos[numero];
                actualizarLocalStorage(seleccionados, pagados, datosBoletos);
                modal.style.display = 'none';
                generarTalonario();
                mostrarNotificacion(`Boleto ${numero.padStart(3, '0')} eliminado`);
            };

            marcarPago.onclick = function () {
                let seleccionados = JSON.parse(localStorage.getItem('numerosSeleccionados3')) || [];
                let pagados = JSON.parse(localStorage.getItem('numerosPagados3')) || [];
                celda.classList.remove('seleccionado');
                celda.classList.add('pagado');
                seleccionados = seleccionados.filter(n => n !== numero.toString());
                if (!pagados.includes(numero.toString())) {
                    pagados.push(numero.toString());
                }
                actualizarLocalStorage(seleccionados, pagados, datosBoletos);
                modal.style.display = 'none';
                generarTalonario();
                mostrarNotificacion(`Boleto ${numero.padStart(3, '0')} marcado como pagado`);
            };

            document.getElementById('cerrarModal').onclick = function () {
                modal.style.display = 'none';
            };

            modal.onclick = function (e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        function actualizarLocalStorage(seleccionados, pagados, datosBoletos) {
            localStorage.setItem('numerosSeleccionados3', JSON.stringify(seleccionados));
            localStorage.setItem('numerosPagados3', JSON.stringify(pagados));
            localStorage.setItem('datosBoletos3', JSON.stringify(datosBoletos));
            verificarTalonarioCompleto(pagados);
            generarListaBoletos();
        }

        function actualizarControles(seleccionados, pagados) {
            const contador = document.getElementById('contadorVendidos');
            const contadorTodo = document.getElementById('contadorTodo');
            const contadorDisponible = document.getElementById('contadorDisponible');
            const contadorApartado = document.getElementById('contadorApartado');
            const contadorPagado = document.getElementById('contadorPagado');

            const total = 1000;
            const apartadosYPagados = seleccionados.length + pagados.length;
            const disponibles = total - apartadosYPagados;

            contador.textContent = `Apartados y Pagados: ${apartadosYPagados}/1000`;
            contadorTodo.textContent = total;
            contadorDisponible.textContent = disponibles;
            contadorApartado.textContent = seleccionados.length;
            contadorPagado.textContent = pagados.length;
        }

        function generarListaBoletos() {
            const lista = document.getElementById('lista');
            if (!lista) {
                console.error('El contenedor #lista no se encontró');
                return;
            }
            lista.innerHTML = '';

            const seleccionados = JSON.parse(localStorage.getItem('numerosSeleccionados3')) || [];
            const pagados = JSON.parse(localStorage.getItem('numerosPagados3')) || [];
            const datosBoletos = JSON.parse(localStorage.getItem('datosBoletos3')) || {};

            const todosBoletos = [
                ...seleccionados.map(num => ({ numero: num, estado: 'apartado' })),
                ...pagados.map(num => ({ numero: num, estado: 'pagado' }))
            ].sort((a, b) => parseInt(a.numero) - parseInt(b.numero));

            todosBoletos.forEach(boleto => {
                const li = document.createElement('li');
                li.classList.add(boleto.estado);
                const numeroFormateado = boleto.numero.padStart(3, '0');
                const datos = datosBoletos[boleto.numero] || { nombre: 'Sin nombre', celular: 'Sin celular' };
                li.innerHTML = `
                    <span>Número ${numeroFormateado}: ${datos.nombre}</span>
                    <span>${boleto.estado === 'apartado' ? 'Apartado' : 'Pagado'}</span>
                `;
                lista.appendChild(li);
            });

            if (todosBoletos.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No hay boletos apartados ni pagados.';
                li.style.color = '#7f8c8d';
                lista.appendChild(li);
            }
        }

        function aplicarFiltro(tipo) {
            filtroActivo = tipo;
            const botonesFiltro = document.querySelectorAll('.filtro');
            botonesFiltro.forEach(btn => btn.classList.remove('activo'));
            document.getElementById(`filtro${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).classList.add('activo');
            generarTalonario();
        }

        function verificarTalonarioCompleto(pagados) {
            const limpiarBtn = document.getElementById('limpiarTalonario');
            if (pagados.length === 1000) {
                localStorage.setItem('talonarioCompleto3', 'true');
                limpiarBtn.style.display = 'block';
            } else {
                localStorage.setItem('talonarioCompleto3', 'false');
                limpiarBtn.style.display = 'none';
            }
        }

        function inicializarLimpiarTalonario() {
            const limpiarBtn = document.getElementById('limpiarTalonario');
            const modalConfirmar = document.getElementById('modalConfirmarLimpieza');
            const confirmarLimpieza = document.getElementById('confirmarLimpieza');
            const cancelarLimpieza = document.getElementById('cancelarLimpieza');
            const cerrarModalConfirmar = document.getElementById('cerrarModalConfirmar');

            limpiarBtn.onclick = function () {
                modalConfirmar.style.display = 'flex';
            };

            confirmarLimpieza.onclick = function () {
                localStorage.removeItem('numerosSeleccionados3');
                localStorage.removeItem('numerosPagados3');
                localStorage.setItem('datosBoletos3', JSON.stringify({}));
                localStorage.setItem('talonarioCompleto3', 'false');
                filtroActivo = 'todo';
                paginaActual = 1;
                document.getElementById('filtroTodo').classList.add('activo');
                document.getElementById('filtroDisponible').classList.remove('activo');
                document.getElementById('filtroApartado').classList.remove('activo');
                document.getElementById('filtroPagado').classList.remove('activo');
                generarTalonario();
                modalConfirmar.style.display = 'none';
                mostrarNotificacion('¡Talonario limpiado exitosamente!');
            };

            cancelarLimpieza.onclick = function () {
                modalConfirmar.style.display = 'none';
            };

            cerrarModalConfirmar.onclick = function () {
                modalConfirmar.style.display = 'none';
            };

            modalConfirmar.onclick = function (e) {
                if (e.target === modalConfirmar) {
                    modalConfirmar.style.display = 'none';
                }
            };
        }

        function mostrarNotificacion(mensaje) {
            const notificacion = document.getElementById('notificacion');
            const mensajeNotificacion = document.getElementById('mensajeNotificacion');
            mensajeNotificacion.textContent = mensaje;
            notificacion.style.display = 'block';
            setTimeout(() => {
                notificacion.style.display = 'none';
            }, 3000);
        }

        function generarFavicon() {
            const canvas = document.createElement('canvas');
            const size = 64;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.src = 'data:image/svg+xml,' + encodeURIComponent(`
                <svg width="128" height="128" xmlns="http://www.w3.org/2000/svg">
                    <foreignObject width="128" height="128">
                        <div xmlns="http://www.w3.org/1999/xhtml" class="icono" style="width: 128px; height: 128px;">
                            <div class="boleto">
                                <span class="numero">Rifa</span>
                                <div class="check"></div>
                            </div>
                        </div>
                    </foreignObject>
                </svg>
            `);

            img.onload = () => {
                ctx.drawImage(img, 0, 0, size, size);
                const favicon = document.getElementById('favicon');
                favicon.href = canvas.toDataURL('image/png');
            };
        }

        window.onpopstate = function(event) {
            if (event) {
                if (navigator.app && navigator.app.exitApp) {
                    navigator.app.exitApp();
                } else {
                    window.close();
                }
            }
        };
    </script>
</body>
</html>